@page "/PumpEdit/{PumpId:int}"

@using MaintenanceWebApp.Data
@using MaintenanceWebApp.Services
@using Microsoft.EntityFrameworkCore
@using System.Globalization
@inject IConfiguration Configuration
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime

@* Services *@
@inject UploadFilesService UploadService
@inject CRUDService CRUDService
@inject NotificationService NotificationService

@* Otorisasi Berdasarkan Peran *@
@attribute [Authorize(Roles = "Admin, Maintenance, Maintenance Supervisor")]
@implements IDisposable

<div class="card">
    <div class="card-header bg-light border-primary">
        @* Header Halaman *@
        <ul class="nav nav-tabs card-header-tabs">
            <li class="nav-item">
                <a @onclick="CancelAsync" class="nav-link" style="cursor:pointer;" aria-label="Kembali ke Daftar Pompa">
                    <span class="oi oi-chevron-left"></span>
                </a>
            </li>
            <li class="nav-item">
                <span class="nav-link active" aria-current="page">Informasi Pompa</span>
            </li>
        </ul>
    </div>
    <div class="card-body">
        @if (pump != null)
        {
            @* Formulir Edit Data *@
            <EditForm Model="pump" OnValidSubmit="HandleUpdatePump" OnInvalidSubmit="HandleInvalidSubmitAsync">
                <DataAnnotationsValidator />

                <div class="form-group row">
                    <div class="col-sm-12 mb-3">
                        <label for="NamaPompa" class="col-form-label">Nama Pompa <span class="required">*</span></label>
                        <InputSelect id="NamaPompa" @bind-Value="pump.Name" class="form-control">
                            <option value="">Pilih Nama Pompa...</option>
                            @foreach (var name in pumpName)
                            {
                                <option value="@name">@name</option>
                            }
                        </InputSelect>
                        <ValidationMessage For="@(() => pump.Name)" />
                    </div>

                    <div class="col-sm-12 mb-3">
                        <label for="TagPompa" class="col-form-label">Tag No Pompa <span class="required">*</span></label>
                        <InputText id="TagPompa" @bind-Value="pump.Tag" class="form-control" />
                        <ValidationMessage For="@(() => pump.Tag)" />
                    </div>

                    <div class="col-sm-6 mb-3">
                        <label for="Merk" class="col-form-label">Merk</label>
                        <InputSelect id="Merk" @bind-Value="pump.Brand" class="form-control">
                            <option value="">Pilih Merk...</option>
                            @foreach (var brand in brandOptions)
                            {
                                <option value="@brand">@brand</option>
                            }
                        </InputSelect>
                        <ValidationMessage For="@(() => pump.Brand)" />
                    </div>

                    <div class="col-sm-6 mb-3">
                        <label for="Tipe" class="col-form-label">Tipe</label>
                        <InputSelect id="Tipe" @bind-Value="pump.Type" class="form-control">
                            <option value="">Pilih Tipe...</option>
                            @foreach (var type in typeOptions)
                            {
                                <option value="@type">@type</option>
                            }
                        </InputSelect>
                        <ValidationMessage For="@(() => pump.Type)" />
                    </div>

                    <div class="col-sm-6 mb-3">
                        <label for="Material" class="col-form-label">Material</label>
                        <InputSelect id="Material" @bind-Value="pump.Material" class="form-control">
                            <option value="">Pilih Material...</option>
                            @foreach (var material in materialOptions)
                            {
                                <option value="@material">@material</option>
                            }
                        </InputSelect>
                        <ValidationMessage For="@(() => pump.Material)" />
                    </div>

                    <div class="col-sm-6 mb-3">
                        <label for="Jenis" class="col-form-label">Jenis</label>
                        <InputSelect id="Jenis" @bind-Value="pump.Category" class="form-control">
                            <option value="">Pilih Jenis...</option>
                            @foreach (var category in categoryOptions)
                            {
                                <option value="@category">@category</option>
                            }
                        </InputSelect>
                        <ValidationMessage For="@(() => pump.Category)" />
                    </div>

                    <div class="col-sm-6 mb-3">
                        <label for="Lokasi" class="col-form-label">Lokasi <span class="required">*</span></label>
                        <InputSelect id="Lokasi" @bind-Value="pump.Location" class="form-control">
                            <option value="">Pilih Lokasi...</option>
                            @foreach (var location in locationOptions)
                            {
                                <option value="@location">@location</option>
                            }
                        </InputSelect>
                        <ValidationMessage For="@(() => pump.Location)" />
                    </div>
                </div>

                <div class="row">
                    <div class="col-sm-6 mb-3">
                        <label for="Tahun" class="col-form-label">Tahun</label>
                        <InputNumber id="Tahun" @bind-Value="pump.Year" class="form-control" />
                        <ValidationMessage For="@(() => pump.Year)" />
                    </div>

                    <div class="col-sm-6 mb-3">
                        <div class="row">
                            <div class="col-sm-8">
                                <label for="Kapasitas" class="col-form-label">Kapasitas</label>
                                <InputText class="form-control" id="Kapasitas" @bind-Value="_capacityInput" @oninput="HandleCapacityInput" />
                                @if (!string.IsNullOrEmpty(_capacityError))
                                {
                                    <div class="text-danger small mt-1">@_capacityError</div>
                                }
                                <ValidationMessage For="@(() => pump.CapacityValue)" />
                            </div>
                            <div class="col-sm-4">
                                <label for="SatuanKapasitas" class="col-form-label">Unit</label>
                                <InputSelect id="SatuanKapasitas" @bind-Value="pump.CapacityUnit" class="form-control" disabled="@IsCapacityUnitDisabled">
                                    <option value="">...</option>
                                    @foreach (var unit in capacityUnits)
                                    {
                                        <option value="@unit">@unit</option>
                                    }
                                </InputSelect>
                                @if (pump.CapacityValue.HasValue && pump.CapacityValue.Value > 0 && string.IsNullOrWhiteSpace(pump.CapacityUnit))
                                {
                                    <div class="text-danger">Unit harus dipilih.</div>
                                }
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-sm-6 mb-3">
                        <div class="mb-3">
                            <label for="DeskripsiDaya" class="col-form-label">Deskripsi Daya (Opsional)</label>
                            <InputText id="DeskripsiDaya" @bind-Value="pump.PowerDescription" class="form-control" placeholder="Contoh: Diesel Engine Cummins" />
                        </div>

                        <div class="row">
                            <div class="col-sm-8">
                                <label for="Daya" class="col-form-label">Daya</label>
                                <InputText class="form-control" id="Daya" @bind-Value="_powerInput" @oninput="HandlePowerInput" />
                                @if (!string.IsNullOrEmpty(_powerError))
                                {
                                    <div class="text-danger small mt-1">@_powerError</div>
                                }
                                <ValidationMessage For="@(() => pump.PowerValue)" />
                            </div>
                            <div class="col-sm-4">
                                <label for="SatuanDaya" class="col-form-label">Unit</label>
                                <InputSelect id="SatuanDaya" @bind-Value="pump.PowerUnit" class="form-control" disabled="@IsPowerUnitDisabled">
                                    <option value="">...</option>
                                    @foreach (var unit in powerUnits)
                                    {
                                        <option value="@unit">@unit</option>
                                    }
                                </InputSelect>
                                @if (pump.PowerValue.HasValue && pump.PowerValue.Value > 0 && string.IsNullOrWhiteSpace(pump.PowerUnit))
                                {
                                    <div class="text-danger">Unit harus dipilih.</div>
                                }
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-sm-12 mb-3">
                    <label for="ExplotionProof" class="col-form-label">Kode Explotion Proof</label>
                    <InputText id="ExplotionProof" @bind-Value="pump.ExplotionProofCode" class="form-control" />
                    <ValidationMessage For="@(() => pump.ExplotionProofCode)" />
                </div>

                <div class="col-sm-12 mb-3">
                    <label for="Foto" class="col-form-label">Foto</label>
                    @if (!fileStatus)
                    {
                        <InputFile id="Foto" class="form-control"
                                   accept=".jpg,.jpeg,.png"
                                   OnChange="HandleFileUploadAsync" />
                        <ValidationMessage For="@(() => filePath)" />
                    }
                    else
                    {
                        <div class="d-flex align-items-center">
                            <img style="border: #e9ecef solid; padding: 10px; border-radius: 5px; max-height: 150px;" src="@CreateFilePath(filePath!)" alt="Pump Image">
                            <button @onclick="HandleFileChangeAsync" type="button" class="btn btn-danger btn-sm ms-3">Ubah Foto</button>
                        </div>
                    }
                </div>

                @* Tombol Aksi *@
                <div class="float-end mt-3">
                    <button type="button" class="btn btn-secondary" @onclick="CancelAsync">Batal</button>
                    <button type="submit" class="btn btn-primary">Simpan</button>
                </div>
            </EditForm>
        }
        else
        {
            <p>Memuat Data Pompa...</p>
        }
    </div>
</div>

@code {
    [Parameter]
    public int PumpId { get; set; }

    private Pump? pump;
    private DotNetObjectReference<PumpEdit>? dotNetHelper;
    private string _webStorageRoot = string.Empty;

    private bool IsPowerUnitDisabled = true;
    private bool IsCapacityUnitDisabled = true;

    private string _capacityInput = string.Empty;
    private string _powerInput = string.Empty;
    private string? _capacityError;
    private string? _powerError;

    private string? originalFilePath;
    private string? filePath;
    private bool fileStatus;

    private const string SUB_FOLDER_NAME = "Inventories";
    private const string FILE_CATEGORY = "img";
    private const string FOLDER_NAME = "Pompa";

    // Form Properties (disamakan dengan PumpAdd)
    private List<string> pumpName = new() { "Pompa Delivery", "Pompa Pendukung Operasional", "Pompa Air Bersih", "Pompa Kondisi Darurat Kebakaran" };
    private List<string> capacityUnits = new() { "GPM", "LPM", "M3/h", "M3/min" };
    private List<string> powerUnits = new() { "HP", "kW", "Watt" };
    private List<string> materialOptions = new() { "Alumunium", "Braze - Kuningan", "Carbon Steel", "Stainless Steel" };
    private List<string> categoryOptions = new() { "Booster Pump", "Centrifugal", "Centrifugal self priming", "Diaphragma 1 Inch", "Diaphragma 2 Inch", "Diaphragma 3 Inch", "Gear", "LUBE", "Multi stage", "Plunger Pump", "Screw", "Submersible", "Submersible/Satelit", "Vertical Pump" };
    private List<string> locationOptions = new() { "Blader Tank", "Box Culvert", "Dump Filing", "Fire Pump Room", "Guesthouse", "Hose Pit 1", "New Pumpit", "Pump Pit 1", "Pump Pit 2", "Pump Pit 2/5", "Pump Pit 4", "Pump Pit 6", "Pump Pit 7", "Sea Water Intake", "Separator", "Tank Pit 1", "Tank Pit 2", "Tank Pit 5", "Tank Pit 6", "Tangki T307", "Tangki T308", "Tangki T502", "Tangki T608", "Utility Building" };
    private List<string> brandOptions = new() { "ARO", "BSK", "CROWN", "DAB PUMP", "DABITALI", "DENSIN", "EBARRA", "GPA PUMP", "GRUNDFOS", "INGERSOLL RAND", "KSA", "MTX", "NIKUNI", "PATTERSON", "ROTOR", "SANYO", "SEEPEX", "SP Pump", "STERLING SSP", "SUNNY KING", "TORISHIMA", "VIKING PUMP", "WORTHINGTON", "XA PUMP", "YONJOU", "YORK" };
    private List<string> typeOptions = new()
    {
        "200 x 150 CN 6", "RG31 7SP-100-38", "8 x 6 MABSH", "K1A2340/A70", "CR 10-18", "P-H137AC-S", "JET 82 M", "66M3 SUS", "PD20A-APP-FTT", "PD10A-APP-FTT", "BA80AL09T3A", "SP-30", "S 200 E", "50DS 52", "80 DL", "3D1DM3", "4SYK 16-10P", "CDWP 30", "CER 80-200", "ETA 65-20", "EC 65-20", "N 4 337", "CPEN 65-200", "SKH 100-28", "EC 80-25", "ETA 150-40", "65-CP-200", "100 CFC", "EC 65-20", "CPEN 50-200", "SPL-.750", "BM-52", "ETA-N200x150", "ETA-N 80x65x160", "RA-50-25 G3", "GU-50-200", "50/20", "32/10", "IH100-65-200A/2-304/CEX", "80/20"
    };

    protected override async Task OnInitializedAsync()
    {
        await LoadConfigurationAsync();
        await LoadPumpDataAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            dotNetHelper = DotNetObjectReference.Create(this);
            await JSRuntime.InvokeVoidAsync("blazorInterop.promptOnBack", dotNetHelper);
        }
    }

    private async Task LoadPumpDataAsync()
    {
        pump = await CRUDService.ReadSingleAsync<Pump, int>(PumpId);
        if (pump == null)
        {
            await NotificationService.AlertMessage("Data Pompa tidak ditemukan.");
            NavigationManager.NavigateTo("./PumpList", forceLoad: true);
        }
        else
        {
            _capacityInput = pump.CapacityValue?.ToString(CultureInfo.InvariantCulture) ?? string.Empty;
            _powerInput = pump.PowerValue?.ToString(CultureInfo.InvariantCulture) ?? string.Empty;
            InitializeFileStatus(pump.Image);
            IsPowerUnitDisabled = !pump.PowerValue.HasValue || pump.PowerValue.Value <= 0;
            IsCapacityUnitDisabled = !pump.CapacityValue.HasValue || pump.CapacityValue.Value <= 0;
        }
    }

    private bool ValidatePowerAndCapacityInputs()
    {
        if (!string.IsNullOrWhiteSpace(_capacityInput))
        {
            var sanitizedInput = _capacityInput.Replace(',', '.');
            if (!double.TryParse(sanitizedInput, NumberStyles.Any, CultureInfo.InvariantCulture, out double parsedValue) || (parsedValue > 0 && string.IsNullOrWhiteSpace(pump.CapacityUnit)))
            {
                return false;
            }
        }
        if (!string.IsNullOrWhiteSpace(_powerInput))
        {
            var sanitizedInput = _powerInput.Replace(',', '.');
            if (!double.TryParse(sanitizedInput, NumberStyles.Any, CultureInfo.InvariantCulture, out double parsedValue) || (parsedValue > 0 && string.IsNullOrWhiteSpace(pump.PowerUnit)))
            {
                return false;
            }
        }
        return true;
    }

    private async Task HandleUpdatePump()
    {
        if (pump == null) return;

        if (!ValidatePowerAndCapacityInputs())
        {
            await NotificationService.AlertMessage("Input tidak valid. Mohon periksa kembali input Kapasitas dan Daya, pastikan format angka benar dan unit telah dipilih.");
            return;
        }

        pump.Image = fileStatus ? filePath : null;
        if (filePath != originalFilePath)
        {
            await DeleteOldFileAsync(originalFilePath);
        }

        await CRUDService.UpdateAsync(pump);
        if (!string.IsNullOrWhiteSpace(CRUDService.CRUDErrorMessage))
        {
            await NotificationService.AlertMessage("Gagal menyimpan data. Silakan coba lagi.");
            return;
        }

        NavigationManager.NavigateTo("./PumpList?status=EditSuccess");
    }

    private async Task HandleInvalidSubmitAsync()
    {
        await NotificationService.AlertMessage("Mohon periksa kembali formulir. Beberapa isian tidak valid.");
    }

    // Metode Handler lainnya (tidak berubah, hanya penyesuaian label error)
    private void HandleCapacityInput(ChangeEventArgs e)
    {
        var inputValue = e.Value?.ToString() ?? string.Empty;
        var sanitizedInput = inputValue.Replace(',', '.');
        _capacityInput = sanitizedInput;
        _capacityError = null;
        if (string.IsNullOrWhiteSpace(sanitizedInput))
        {
            pump!.CapacityValue = null;
            IsCapacityUnitDisabled = true;
            pump.CapacityUnit = null;
            return;
        }
        if (double.TryParse(sanitizedInput, NumberStyles.Any, CultureInfo.InvariantCulture, out double parsedValue))
        {
            pump!.CapacityValue = parsedValue;
        }
        else
        {
            _capacityError = "Input Kapasitas harus berupa angka (desimal dipersilakan).";
            _capacityInput = string.Empty;
            pump!.CapacityValue = null;
        }
        IsCapacityUnitDisabled = !pump.CapacityValue.HasValue || pump.CapacityValue.Value <= 0;
        if (IsCapacityUnitDisabled) { pump.CapacityUnit = null; }
    }

    private void HandlePowerInput(ChangeEventArgs e)
    {
        var inputValue = e.Value?.ToString() ?? string.Empty;
        var sanitizedInput = inputValue.Replace(',', '.');
        _powerInput = sanitizedInput;
        _powerError = null;
        if (string.IsNullOrWhiteSpace(sanitizedInput))
        {
            pump!.PowerValue = null;
            IsPowerUnitDisabled = true;
            pump.PowerUnit = null;
            return;
        }
        if (double.TryParse(sanitizedInput, NumberStyles.Any, CultureInfo.InvariantCulture, out double parsedValue))
        {
            pump!.PowerValue = parsedValue;
        }
        else
        {
            _powerError = "Input Daya harus berupa angka (desimal dipersilakan).";
            _powerInput = string.Empty;
            pump!.PowerValue = null;
        }
        IsPowerUnitDisabled = !pump.PowerValue.HasValue || pump.PowerValue.Value <= 0;
        if (IsPowerUnitDisabled) { pump.PowerUnit = null; }
    }

    #region Kode Lainnya
    private async Task LoadConfigurationAsync()
    {
        try { _webStorageRoot = Configuration.GetValue<string>("WebStorageRoot") ?? "/"; }
        catch (Exception ex) { await NotificationService.AlertMessage($"Gagal memuat konfigurasi. Detail: {ex.Message}"); }
    }
    private void InitializeFileStatus(string? imagePath)
    {
        fileStatus = !string.IsNullOrWhiteSpace(imagePath);
        originalFilePath = imagePath;
        filePath = imagePath;
    }
    private async Task HandleFileUploadAsync(InputFileChangeEventArgs e)
    {
        try
        {
            await UploadService.FilesUpload(e.File, FOLDER_NAME, SUB_FOLDER_NAME, FILE_CATEGORY);
            if (!string.IsNullOrEmpty(UploadService.UploadErrorMessage))
            {
                await NotificationService.AlertMessage($"Gagal mengunggah gambar. Detail: {UploadService.UploadErrorMessage}");
                filePath = null;
                return;
            }
            filePath = UploadService.FilePath;
            fileStatus = true;
        }
        catch (Exception ex) { await NotificationService.AlertMessage($"Terjadi kesalahan saat mengunggah file. Detail: {ex.Message}"); }
    }
    private async Task HandleFileChangeAsync()
    {
        if (fileStatus && filePath != originalFilePath)
        {
            await DeleteOldFileAsync(filePath);
        }
        fileStatus = !fileStatus;
    }
    private async Task DeleteOldFileAsync(string? path)
    {
        if (!string.IsNullOrWhiteSpace(path))
        {
            await UploadService.FileChange(path, SUB_FOLDER_NAME);
        }
    }
    private string CreateFilePath(string relativePath)
    {
        if (string.IsNullOrWhiteSpace(relativePath)) { return "/noimg.png"; }
        return Path.Combine(_webStorageRoot, relativePath).Replace("\\", "/");
    }
    private async Task CancelAsync()
    {
        if (filePath != originalFilePath)
        {
            await DeleteOldFileAsync(filePath);
        }
        NavigationManager.NavigateTo("./PumpList");
    }
    [JSInvokable]
    public async Task HandleBackNavigation()
    {
        await CancelAsync();
    }
    public void Dispose()
    {
        dotNetHelper?.Dispose();
        JSRuntime.InvokeVoidAsync("blazorInterop.removeOnPopState");
    }
    #endregion
}