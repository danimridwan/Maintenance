@page "/UserInfo/{Id}"

@using MaintenanceWebApp.Data
@using MaintenanceWebApp.Services
@using Microsoft.EntityFrameworkCore
@inject IConfiguration Configuration
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime

@* Services *@
@inject CRUDService CRUDService
@inject NotificationService NotificationService

@* Roles Authorize *@
@attribute [Authorize(Roles = "Admin, Supervisor, Manager, Terminal Manager, Maintenance Supervisor, Maintenance")]

<div class="card shadow-sm">
    @* Header Halaman *@
    <div class="card-header bg-light border-primary d-flex justify-content-between align-items-center">
        <ul class="nav nav-tabs card-header-tabs">
            <AuthorizeView Roles="Admin, Terminal Manager, Maintenance Supervisor">
                <Authorized>
                    <li class="nav-item">
                        <a style="cursor: pointer;" @onclick="NavigateToUserList" class="nav-link" aria-label="Kembali ke Daftar Pengguna">
                            <span class="oi oi-chevron-left"></span>
                        </a>
                    </li>
                </Authorized>
            </AuthorizeView>
            <li class="nav-item">
                <span class="nav-link active" aria-current="page">Informasi Pengguna</span>
            </li>
        </ul>
        <button class="btn btn-warning btn-sm" @onclick="GoToUserEdit">
            <span class="oi oi-pencil"></span> Edit
        </button>
    </div>

    @* Status Pemuatan *@
    @if (isLoading)
    {
        <div class="card-body text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Memuat...</span>
            </div>
            <p class="mt-2">Memuat data pengguna...</p>
        </div>
    }
    @* Status Data Tidak Ditemukan *@
    else if (user is null)
    {
        <div class="card-body text-center py-5">
            <div class="alert alert-warning" role="alert">
                <h4 class="alert-heading">Data Tidak Ditemukan!</h4>
                <p>Pengguna dengan ID yang diberikan tidak ada atau terjadi kesalahan saat memuat data.</p>
                <hr>
                <p class="mb-0">Mohon cek kembali ID pengguna atau hubungi administrator.</p>
            </div>
        </div>
    }
    @* Detail Pengguna *@
    else
    {
        <div class="card-body">
            <div class="row align-items-start">
                @* Bagian Foto Profil *@
                <div class="col-md-4 text-center mb-4">
                    <div class="profile-photo-container">
                        <img class="img-fluid rounded-circle shadow-sm" src="@CreateFilePath(user.UserPhoto)" alt="Foto Profil Pengguna" style="max-width: 200px; height: auto;" />
                    </div>
                </div>

                @* Bagian Informasi Detail *@
                <div class="col-md-8">
                    <h4 class="mb-3">@user.FullName</h4>
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item">
                            <i class="oi oi-envelope-closed me-2"></i> <b>Email:</b> @user.Email
                        </li>
                        <li class="list-group-item">
                            <i class="oi oi-phone me-2"></i> <b>Nomor Telepon:</b> @user.PhoneNumber
                        </li>
                        <li class="list-group-item">
                            <i class="oi oi-person me-2"></i> <b>Role:</b> @user.Role
                        </li>
                        @if (!string.IsNullOrEmpty(user.Section))
                        {
                            <li class="list-group-item">
                                <i class="oi oi-briefcase me-2"></i> <b>Section:</b> @user.Section
                            </li>
                        }
                        @if (!string.IsNullOrEmpty(user.RoleCategory))
                        {
                            <li class="list-group-item">
                                <i class="oi oi-tag me-2"></i> <b>Divisi:</b> @user.RoleCategory
                            </li>
                        }
                    </ul>

                    @if (user.Role != "Admin")
                    {
                        <div class="signature-section border-top pt-4">
                            <h5 class="mb-3">Tanda Tangan Digital</h5>
                            <img class="img-fluid border rounded shadow-sm" src="@CreateFilePath(user.Signature)" alt="Tanda Tangan Pengguna" style="max-height: 150px;" />
                        </div>
                    }
                </div>
            </div>
        </div>
    }
</div>

@code {
    // Parameter dari URL
    [Parameter]
    public string Id { get; set; } = default!;

    // Properti State
    private User? user;
    private bool isLoading = true;
    private string? previousId;

    // Konstanta
    private string webUserRoot = string.Empty;
    private const string NO_IMAGE_PATH = "./noimg.png";
    private const string USER_LIST_PATH = "./UserList";

    // Metode Lifecycle
    protected override async Task OnInitializedAsync()
    {
        await LoadConfigurationAsync();
    }

    protected override async Task OnParametersSetAsync()
    {
        if (Id != previousId)
        {
            isLoading = true;
            previousId = Id;
            await LoadUserAsync();
        }
    }

    // Metode Bantuan (Helper Methods)
    private async Task LoadConfigurationAsync()
    {
        try
        {
            webUserRoot = Configuration.GetValue<string>("WebUserRoot") ?? "/";
        }
        catch (Exception ex)
        {
            await NotificationService.AlertMessage("Gagal memuat konfigurasi `WebUserRoot`. Silakan hubungi Administrator.");
            NotificationService.LogMessage($"Gagal memuat konfigurasi `WebUserRoot`: {ex}");
        }
    }

    private async Task LoadUserAsync()
    {
        user = await CRUDService.ReadSingleAsync<User, string>(Id);
        isLoading = false;

        if (!string.IsNullOrEmpty(CRUDService.CRUDErrorMessage))
        {
            await NotificationService.AlertMessage($"Gagal memuat data pengguna: {CRUDService.CRUDErrorMessage}");
            NotificationService.LogMessage($"Gagal memuat data pengguna dengan ID {Id}: {CRUDService.CRUDErrorMessage}");
        }
    }

    private string CreateFilePath(string? relativePath)
    {
        if (string.IsNullOrWhiteSpace(relativePath))
        {
            return NO_IMAGE_PATH;
        }
        string fullPath = Path.Combine(webUserRoot, relativePath);
        return fullPath.Replace("\\", "/");
    }

    // Navigasi
    private void GoToUserEdit()
    {
        if (user != null)
        {
            NavigationManager.NavigateTo($"./UserEdit/{user.Id}");
        }
    }

    private void NavigateToUserList()
    {
        NavigationManager.NavigateTo(USER_LIST_PATH);
    }
}